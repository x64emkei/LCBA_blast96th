<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LCBA 96th Anniversary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        deepBlue: '#0f172a',    // Dark Slate
                        royalBlue: '#1e3a8a',   // Strong Blue
                        royalBlueLight: '#3b82f6',
                        gold: '#fbbf24',        // Amber 400
                        goldDark: '#b45309',    // Amber 700
                        goldLight: '#fcd34d',   // Amber 300
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            /* Darker Gradient Theme */
            background: linear-gradient(180deg, #020617 0%, #172554 100%);
            color: #f8fafc;
            min-height: 100vh;
            overscroll-behavior: none;
        }

        /* Gold Gradient Text */
        .text-gradient-gold {
            background: linear-gradient(to right, #fcd34d, #fbbf24, #b45309);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glassmorphism Dark */
        .glass-dark {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(251, 191, 36, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Custom Input Styling */
        .custom-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .custom-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #fbbf24;
            outline: none;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #fbbf24;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* Canvas */
        canvas { 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
            border: 2px solid #fbbf24;
        }

        /* Utils */
        .force-hidden { display: none !important; }
        .force-visible { display: flex !important; }
        
        #main-content { opacity: 0; transition: opacity 0.5s ease; }
        #main-content.loaded { opacity: 1; }

        /* Step Animations */
        .step-content {
            display: none;
            animation: fadeInSlide 0.4s ease forwards;
        }
        .step-content.active { display: block; }
        
        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #fbbf24;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Cursor */
        .cursor-move-all { cursor: move; cursor: -webkit-grabbing; }
    </style>
    
    <script>
        (function() {
            var ua = navigator.userAgent || navigator.vendor || window.opera;
            var isInApp = /(FBAN|FBAV|Instagram|LinkedIn|Twitter|Bytespider)/i.test(ua);
            window.isBlockedBrowser = isInApp;
        })();
    </script>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-[#020617] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="loader mb-4"></div>
        </div>
        <p class="text-gold font-serif tracking-widest text-sm animate-pulse">LOADING EXPERIENCE</p>
    </div>

    <div id="browser-blocker" class="hidden fixed inset-0 z-[9999] flex-col justify-center items-center bg-[#020617] p-6 text-center">
        <div class="max-w-md w-full glass-panel p-8 rounded-2xl border border-red-500/30">
            <i data-lucide="alert-triangle" class="w-16 h-16 text-gold mx-auto mb-4"></i>
            <h2 class="text-2xl font-serif font-bold text-white mb-2">Browser Not Supported</h2>
            <p class="text-gray-300 mb-6">Facebook and Instagram browsers prevent image downloads. Please open in your system browser.</p>
            
            <div class="flex flex-col gap-3">
                <div class="bg-white/5 p-3 rounded-lg flex items-center gap-3">
                    <span class="text-2xl">ü§ñ</span>
                    <div class="text-left">
                        <p class="font-bold text-white text-sm">Android</p>
                        <p class="text-xs text-gray-400">Tap <span class="text-gold">‚ãÆ</span> ‚Üí Open in Chrome</p>
                    </div>
                </div>
                <div class="bg-white/5 p-3 rounded-lg flex items-center gap-3">
                    <span class="text-2xl">üçé</span>
                    <div class="text-left">
                        <p class="font-bold text-white text-sm">iPhone (iOS)</p>
                        <p class="text-xs text-gray-400">Tap <span class="text-gold">Share</span> ‚Üí Open in Safari</p>
                    </div>
                </div>
            </div>
            
            <button id="copy-link-btn" class="mt-6 w-full bg-gold text-deepBlue font-bold py-3 rounded-xl hover:bg-goldLight transition">
                Copy Link to Clipboard
            </button>
            <p id="copy-feedback" class="text-green-400 text-sm mt-2 h-5"></p>
        </div>
    </div>

    <div id="main-content">
        <header class="fixed top-0 left-0 right-0 z-50 glass-dark shadow-2xl border-b border-white/5">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="LCBA_Seal.png" alt="LCBA" class="w-10 h-10 object-contain drop-shadow-lg">
                    <div class="h-6 w-px bg-white/20"></div>
                    <img src="dpblast_logo.png" alt="DP Blast" class="h-8 w-auto object-contain opacity-80">
                </div>
                <div class="text-right">
                    <p class="text-xs text-gold uppercase tracking-[0.2em] font-bold">96th Anniversary</p>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 pt-28 pb-12 max-w-xl">
            
            <div class="text-center mb-8 animate-[fadeIn_1s_ease-out]">
                <img src="96th_logo.png" alt="96 Logo" class="w-32 h-32 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(251,191,36,0.3)]">
                <h1 class="font-serif text-4xl md:text-5xl font-bold text-white mb-2">96 Years of <span class="text-gradient-gold">Excellence</span></h1>
                <p class="text-blue-200 text-sm font-medium tracking-wide">CREATE YOUR ANNIVERSARY FRAME</p>
            </div>

            <div class="flex justify-between items-center mb-8 px-4 relative">
                <div class="absolute left-0 right-0 top-1/2 h-0.5 bg-white/10 -z-10"></div>
                <div id="step-ind-1" class="w-10 h-10 rounded-full bg-gold text-deepBlue font-bold flex items-center justify-center shadow-[0_0_15px_rgba(251,191,36,0.5)] transition-all">1</div>
                <div id="step-ind-2" class="w-10 h-10 rounded-full bg-slate-700 text-gray-400 font-bold flex items-center justify-center border border-white/10 transition-all">2</div>
                <div id="step-ind-3" class="w-10 h-10 rounded-full bg-slate-700 text-gray-400 font-bold flex items-center justify-center border border-white/10 transition-all">3</div>
            </div>

            <div class="glass-panel rounded-3xl p-1 shadow-2xl overflow-hidden">
                
                <div id="step-1" class="step-content active p-6 md:p-8">
                    <h2 class="text-2xl font-serif text-white mb-1">Who are you?</h2>
                    <p class="text-gray-400 text-sm mb-6">Enter your name to generate your caption.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gold text-xs font-bold uppercase tracking-wider mb-2">Full Name</label>
                            <input type="text" id="user-name" class="custom-input w-full p-4 rounded-xl text-lg placeholder-gray-500" placeholder="e.g. Juan Dela Cruz">
                        </div>
                        
                        <div class="bg-black/30 rounded-xl p-4 border border-white/5">
                            <label class="block text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Caption Preview</label>
                            <div id="caption-preview" class="text-gray-300 text-sm italic leading-relaxed h-32 overflow-y-auto pr-2 custom-scrollbar">
                                Start typing your name above to see the magic happen...
                            </div>
                        </div>

                        <button onclick="goToStep(2)" class="w-full bg-gold hover:bg-goldLight text-deepBlue font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 mt-4">
                            Next Step <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="step-2" class="step-content p-6 md:p-8">
                    <h2 class="text-2xl font-serif text-white mb-1">Upload Photo</h2>
                    <p class="text-gray-400 text-sm mb-6">Choose a clear photo of yourself.</p>

                    <label class="relative group cursor-pointer block">
                        <div class="border-2 border-dashed border-white/20 rounded-2xl p-10 text-center hover:border-gold hover:bg-white/5 transition-all">
                            <div class="w-16 h-16 rounded-full bg-blue-900/50 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="image-plus" class="w-8 h-8 text-gold"></i>
                            </div>
                            <p class="text-white font-medium">Tap to Select Photo</p>
                            <p class="text-gray-500 text-xs mt-2">Supports JPG, PNG</p>
                        </div>
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                    </label>

                    <div class="flex gap-3 mt-6">
                        <button onclick="goToStep(1)" class="flex-1 bg-transparent border border-white/20 text-white font-bold py-4 rounded-xl hover:bg-white/5 transition">
                            Back
                        </button>
                    </div>
                </div>

                <div id="step-3" class="step-content p-6 md:p-8">
                    <h2 class="text-2xl font-serif text-white mb-1">Final Adjustments</h2>
                    <p class="text-gray-400 text-sm mb-6">Pinch or drag to position your photo.</p>

                    <div class="relative w-full aspect-square bg-black/50 rounded-lg overflow-hidden border border-white/10 mb-6 group">
                        <div class="absolute top-4 left-0 right-0 text-center pointer-events-none z-10 opacity-70">
                            <span class="bg-black/60 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm border border-white/10">
                                <i data-lucide="move" class="inline w-3 h-3 mr-1"></i> DRAG & PINCH
                            </span>
                        </div>
                        
                        <canvas id="canvas" class="w-full h-full cursor-move-all block"></canvas>
                    </div>

                    <div class="flex items-center gap-4 mb-6 bg-black/20 p-3 rounded-xl border border-white/5">
                        <i data-lucide="minus" class="w-4 h-4 text-gray-400"></i>
                        <input type="range" id="zoom-slider" min="0.1" max="3" step="0.05" value="1" class="flex-1">
                        <i data-lucide="plus" class="w-4 h-4 text-gray-400"></i>
                    </div>

                    <div class="space-y-3">
                        <button id="download-btn" class="w-full bg-gradient-to-r from-gold to-goldDark text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(251,191,36,0.3)] transition-transform active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i> Download Image
                        </button>
                        
                        <button id="copy-caption-btn" class="w-full bg-royalBlue hover:bg-blue-800 text-white font-bold py-4 rounded-xl border border-white/10 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <i data-lucide="copy" class="w-5 h-5"></i> Copy Caption
                        </button>
                    </div>
                     <button onclick="goToStep(2)" class="mt-4 w-full text-gray-500 text-sm hover:text-white">Start Over / Change Photo</button>
                </div>

            </div>

        </div>

        <footer class="bg-[#020617] text-center py-10 border-t border-white/10">
            <h3 class="font-serif text-gold text-lg font-bold tracking-widest mb-6">LAGUNA COLLEGE OF<br>BUSINESS AND ARTS</h3>
            
            <a href="https://www.facebook.com/LCBAofficial" target="_blank" class="inline-flex items-center gap-2 text-blue-300 hover:text-white transition-colors mb-8">
                <i data-lucide="facebook" class="w-5 h-5"></i> Visit Official Page
            </a>

            <div class="text-xs text-gray-500 space-y-1">
                <p>Graphics by Miguel Madamba ‚Ä¢ Web by Michael Ordenes</p>
                <p>Visitor Count: <span id="visitor-count" class="text-gold font-bold">0</span></p>
                <p class="mt-4 opacity-50">¬© 2026 LCBA. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        const CANVAS_SIZE = 1080;
        let state = {
            page: 1,
            scale: 1,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            pinchDist: null,
            userName: '',
            userImage: null
        };

        // --- 2. ASSETS ---
        const frameImage = new Image();
        frameImage.crossOrigin = "Anonymous";
        frameImage.src = 'LCBA-96th_frame.png';

        // --- 3. DOM ELEMENTS ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const nameInput = document.getElementById('user-name');
        const captionPreview = document.getElementById('caption-preview');
        const fileInput = document.getElementById('image-upload');
        const zoomSlider = document.getElementById('zoom-slider');
        const downloadBtn = document.getElementById('download-btn');

        // --- 4. INITIALIZATION ---
        window.addEventListener('load', () => {
            // Check Browser Blocker
            if (window.isBlockedBrowser) {
                document.getElementById('browser-blocker').classList.remove('hidden');
                document.getElementById('browser-blocker').classList.add('force-visible');
                document.getElementById('loading-screen').classList.add('hidden');
            } else {
                // Initialize App
                canvas.width = CANVAS_SIZE;
                canvas.height = CANVAS_SIZE;
                
                // Load visitor count
                let count = localStorage.getItem('visitorCountLCBA96') || 0;
                count = parseInt(count) + 1;
                localStorage.setItem('visitorCountLCBA96', count);
                document.getElementById('visitor-count').textContent = count;

                // Frame Loaded?
                frameImage.onload = () => {
                    draw();
                    // Hide Loader
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('main-content').classList.add('loaded');
                        }, 500);
                    }, 800);
                };
            }
            lucide.createIcons();
        });

        // --- 5. NAVIGATION LOGIC ---
        window.goToStep = function(step) {
            // Validation
            if (step === 2 && nameInput.value.trim() === '') {
                nameInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => nameInput.classList.remove('ring-2', 'ring-red-500'), 500);
                return;
            }

            // Update UI
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update Indicators
            for(let i=1; i<=3; i++) {
                const ind = document.getElementById(`step-ind-${i}`);
                if (i === step) {
                    ind.className = "w-10 h-10 rounded-full bg-gold text-deepBlue font-bold flex items-center justify-center shadow-[0_0_15px_rgba(251,191,36,0.5)] transition-all";
                } else if (i < step) {
                    ind.className = "w-10 h-10 rounded-full bg-blue-900 text-gold font-bold flex items-center justify-center border border-gold/50 transition-all";
                    ind.innerHTML = "‚úì";
                } else {
                    ind.className = "w-10 h-10 rounded-full bg-slate-700 text-gray-400 font-bold flex items-center justify-center border border-white/10 transition-all";
                    ind.innerHTML = i;
                }
            }
            state.page = step;
        }

        // --- 6. CORE LOGIC ---

        // A. Caption Generation (BUG FIX HERE)
        // Removed Unicode converter to fix Korean text issue.
        function generateCaption(name) {
            const safeName = name.trim() || "[NAME]";
            // We use simple markers around the name or standard text to ensure compatibility
            return `ùüóùüî ùêòùêûùêöùê´ùê¨. ùêìùê°ùê®ùêÆùê¨ùêöùêßùêùùê¨ ùê®ùêü ùêÄùêúùêúùê®ùê¶ùê©ùê•ùê¢ùê¨ùê°ùêûùêù ùêãùêûùêöùêùùêûùê´ùê¨. ùêéùêßùêû ùêãùêÇùêÅùêÄ.\n\nI am ${safeName}. I am an ùêãùêÇùêÅùêÄùê¢ùêöùêß, and I am part of the legacy. Celebrating nearly a century of transforming lives and expanding opportunities. Spanning 9 decades of academic leadership, our commitment to excellence remains the people's trust; a history proven by the thousands of graduates who continue to lead in their chosen fields.\n\nùêéùêÆùê´ ùêúùê®ùêßùê≠ùê¢ùêßùêÆùêûùêù ùê¨ùêÆùêúùêúùêûùê¨ùê¨ ùê¢ùê¨ ùê´ùê®ùê®ùê≠ùêûùêù ùê¢ùêß ùê®ùêÆùê´ ùêúùê®ùê´ùêû ùêØùêöùê•ùêÆùêûùê¨: ùêèùê®ùê¨ùê¢ùê≠ùê¢ùêØùê¢ùê≠ùê≤ that fuels our growth, ùêàùêßùê≠ùêûùê†ùê´ùê¢ùê≠ùê≤ that defines our character, ùêåùê¢ùêßùêùùêüùêÆùê•ùêßùêûùê¨ùê¨ in our actions, and ùêÑùê±ùêúùêûùê•ùê•ùêûùêßùêúùêû in our impact. These values are the reason why an ùêãùêÇùêÅùêÄ education remains a lifelong advantage.\n\nùêà ùêöùê¶ ùê©ùê´ùê®ùêÆùêù ùê≠ùê® ùêúùêöùê´ùê´ùê≤ ùê≠ùê°ùê¢ùê¨ ùê•ùêûùê†ùêöùêúùê≤ ùêöùê¨ ùê∞ùêû ùêúùêûùê•ùêûùêõùê´ùêöùê≠ùêû ùê®ùêÆùê´ ùüóùüîùê≠ùê° ùêÖùê®ùêÆùêßùêùùê¢ùêßùê† ùêÄùêßùêßùê¢ùêØùêûùê´ùê¨ùêöùê´ùê≤.\n\nùë≥ùíÇùíåùíäùíèùíà ùë≥ùë™ùë©ùë®. ùëµùíêùíêùíè ùíÇùíï ùëµùíàùíÇùíöùíêùíè. #LCBA96`;
        }

        nameInput.addEventListener('input', (e) => {
            state.userName = e.target.value;
            if (state.userName) {
                captionPreview.innerText = generateCaption(state.userName);
                captionPreview.classList.remove('italic', 'text-gray-500');
                captionPreview.classList.add('text-white');
            } else {
                captionPreview.innerText = "Start typing your name above to see the magic happen...";
                captionPreview.classList.add('italic', 'text-gray-500');
            }
        });

        // B. Image Handling
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.userImage = img;
                    // Reset Transforms to "Cover"
                    const scaleW = CANVAS_SIZE / img.width;
                    const scaleH = CANVAS_SIZE / img.height;
                    state.scale = Math.max(scaleW, scaleH);
                    state.offsetX = 0;
                    state.offsetY = 0;
                    
                    // Update UI Controls
                    zoomSlider.value = state.scale;
                    zoomSlider.min = state.scale * 0.1;
                    zoomSlider.max = state.scale * 3;
                    
                    draw();
                    goToStep(3);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // C. Canvas Draw
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. Draw User Image
            if (state.userImage) {
                ctx.save();
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.translate(state.offsetX, state.offsetY);
                ctx.scale(state.scale, state.scale);
                ctx.drawImage(state.userImage, -state.userImage.width/2, -state.userImage.height/2);
                ctx.restore();
            } else {
                // Placeholder background
                ctx.fillStyle = "#0f172a";
                ctx.fillRect(0,0, canvas.width, canvas.height);
            }

            // 2. Draw Frame
            if (frameImage.complete) {
                ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
            }
        }

        // --- 7. INTERACTION HANDLERS (PAN & ZOOM) ---
        
        // Mouse
        canvas.addEventListener('mousedown', (e) => {
            if(!state.userImage) return;
            state.isDragging = true;
            state.lastX = e.clientX;
            state.lastY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - state.lastX;
            const dy = e.clientY - state.lastY;
            
            // Adjust sensitivity based on display size vs canvas size
            const rect = canvas.getBoundingClientRect();
            const ratio = canvas.width / rect.width;
            
            state.offsetX += dx * ratio;
            state.offsetY += dy * ratio;
            state.lastX = e.clientX;
            state.lastY = e.clientY;
            draw();
        });

        window.addEventListener('mouseup', () => {
            state.isDragging = false;
            canvas.style.cursor = 'move';
        });

        // Touch
        canvas.addEventListener('touchstart', (e) => {
            if(!state.userImage) return;
            if (e.touches.length === 1) {
                state.isDragging = true;
                state.lastX = e.touches[0].clientX;
                state.lastY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                state.isDragging = false;
                state.pinchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                state.lastScale = state.scale;
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if(!state.userImage) return;
            e.preventDefault();

            if (e.touches.length === 1 && state.isDragging) {
                const dx = e.touches[0].clientX - state.lastX;
                const dy = e.touches[0].clientY - state.lastY;
                const rect = canvas.getBoundingClientRect();
                const ratio = canvas.width / rect.width;

                state.offsetX += dx * ratio;
                state.offsetY += dy * ratio;
                state.lastX = e.touches[0].clientX;
                state.lastY = e.touches[0].clientY;
                draw();
            } else if (e.touches.length === 2 && state.pinchDist) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                state.scale = state.lastScale * (dist / state.pinchDist);
                zoomSlider.value = state.scale;
                draw();
            }
        }, { passive: false });

        canvas.addEventListener('touchend', () => {
            state.isDragging = false;
            state.pinchDist = null;
        });

        // Slider
        zoomSlider.addEventListener('input', (e) => {
            state.scale = parseFloat(e.target.value);
            draw();
        });

        // --- 8. ACTIONS ---
        
        // Download
        downloadBtn.addEventListener('click', () => {
            if (!state.userImage) return;
            
            const link = document.createElement('a');
            link.download = `LCBA_96th_${state.userName.replace(/\s+/g, '_') || 'Anniversary'}.png`;
            link.href = canvas.toDataURL("image/png", 0.9); // High quality
            link.click();
            
            // Show Success Feedback on button
            const originalContent = downloadBtn.innerHTML;
            downloadBtn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Saved!`;
            downloadBtn.classList.remove('from-gold', 'to-goldDark');
            downloadBtn.classList.add('bg-green-600');
            lucide.createIcons();
            
            setTimeout(() => {
                downloadBtn.innerHTML = originalContent;
                downloadBtn.classList.add('from-gold', 'to-goldDark');
                downloadBtn.classList.remove('bg-green-600');
                lucide.createIcons();
            }, 2000);
        });

        // Copy Caption
        document.getElementById('copy-caption-btn').addEventListener('click', () => {
            const txt = generateCaption(state.userName);
            navigator.clipboard.writeText(txt).then(() => {
                const btn = document.getElementById('copy-caption-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Copied!`;
                btn.classList.replace('bg-royalBlue', 'bg-green-600');
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('bg-green-600', 'bg-royalBlue');
                    lucide.createIcons();
                }, 2000);
            });
        });

        // Copy Browser Link
        document.getElementById('copy-link-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                document.getElementById('copy-feedback').innerText = "Link copied! Open Chrome/Safari and paste.";
            });
        });

    </script>
</body>
</html>
